class MicronParser{constructor(e=!0,t=!0){this.darkTheme=e,this.enableForceMonospace=t,this.DEFAULT_FG_DARK="ddd",this.DEFAULT_FG_LIGHT="222",this.DEFAULT_BG="default",this.enableForceMonospace&&this.injectMonospaceStyles();try{"undefined"==typeof DOMPurify&&console.warn("DOMPurify is not installed. Include it above micron-parser.js or run npm install dompurify")}catch(e){console.warn("DOMPurify is not installed. Include it above micron-parser.js or run npm install dompurify")}this.SELECTED_STYLES=null,this.STYLES_DARK={plain:{fg:this.DEFAULT_FG_DARK,bg:this.DEFAULT_BG,bold:!1,underline:!1,italic:!1},heading1:{fg:"222",bg:"bbb",bold:!1,underline:!1,italic:!1},heading2:{fg:"111",bg:"999",bold:!1,underline:!1,italic:!1},heading3:{fg:"000",bg:"777",bold:!1,underline:!1,italic:!1}},this.STYLES_LIGHT={plain:{fg:this.DEFAULT_FG_LIGHT,bg:this.DEFAULT_BG,bold:!1,underline:!1,italic:!1},heading1:{fg:"000",bg:"777",bold:!1,underline:!1,italic:!1},heading2:{fg:"111",bg:"aaa",bold:!1,underline:!1,italic:!1},heading3:{fg:"222",bg:"ccc",bold:!1,underline:!1,italic:!1}},this.darkTheme?this.SELECTED_STYLES=this.STYLES_DARK:this.SELECTED_STYLES=this.STYLES_LIGHT}injectMonospaceStyles(){if(document.getElementById("micron-monospace-styles"))return;const e=document.createElement("style");e.id="micron-monospace-styles",e.textContent="\n            .Mu-nl {\n                cursor: pointer;\n            }\n            .Mu-mnt {\n                display: inline-block;\n                width: 0.6em;\n                text-align: center;\n                white-space: pre;\n                text-decoration: inherit;\n            }\n            .Mu-mws {\n                text-decoration: inherit;\n                display: inline-block;\n            }\n        ",document.head.appendChild(e)}static formatNomadnetworkUrl(e){return`nomadnetwork://${e}`}convertMicronToHtml(e){let t="",l={literal:!1,depth:0,fg_color:this.SELECTED_STYLES.plain.fg,bg_color:this.DEFAULT_BG,formatting:{bold:!1,underline:!1,italic:!1,strikethrough:!1},default_align:"left",align:"left",radio_groups:{}};const n=e.split("\n");for(let e of n){const n=this.parseLine(e,l);if(n&&n.length>0)for(let e of n)t+=e.outerHTML;else n&&0===n.length||(t+="<br>")}try{return DOMPurify.sanitize(t,{USE_PROFILES:{html:!0}})}catch(e){return console.warn("DOMPurify is not installed. Include it above micron-parser.js or run npm install dompurify ",e),'<p style="color: red;"> âš  DOMPurify is not installed. Include it above micron-parser.js or run npm install dompurify </p>'}}convertMicronToFragment(e){const t=document.createDocumentFragment();let l={literal:!1,depth:0,fg_color:this.SELECTED_STYLES.plain.fg,bg_color:this.DEFAULT_BG,formatting:{bold:!1,underline:!1,italic:!1,strikethrough:!1},default_align:"left",align:"left",radio_groups:{}};const n=e.split("\n");for(let e of n){e=DOMPurify.sanitize(e,{USE_PROFILES:{html:!0}});const n=this.parseLine(e,l);if(n&&n.length>0)for(let e of n)t.appendChild(e);else n&&0===n.length||t.appendChild(document.createElement("br"))}return t}parseLine(e,t){if(e.length>0){if("`="===e)return t.literal=!t.literal,null;if(!t.literal){if("#"===e[0])return[];if("<"===e[0])return t.depth=0,this.parseLine(e.slice(1),t);if(">"===e[0]){let l=0;for(;l<e.length&&">"===e[l];)l++;t.depth=l;let n=e.slice(l);if(n.length>0){let e=null,i="heading"+l;e=this.SELECTED_STYLES[i]?this.SELECTED_STYLES[i]:this.SELECTED_STYLES.plain;const r=this.stateToStyle(t);this.styleToState(e,t);let s=this.makeOutput(t,n);if(this.styleToState(r,t),s&&s.length>0){const l=document.createElement("div");l.style.display="inline-block",l.style.width="100%",this.applyStyleToElement(l,e);const n=document.createElement("div");this.applySectionIndent(n,t),this.appendOutput(n,s,t),l.appendChild(n);return[l,document.createElement("br")]}if(s&&s.length>0){const e=document.createElement("div");return this.applyAlignment(e,t),this.applySectionIndent(e,t),this.appendOutput(e,s,t),[e]}return null}return null}if("-"===e[0]){if(1===e.length){const e=document.createElement("hr");return this.applySectionIndent(e,t),[e]}{const l=e[1].repeat(250),n=document.createElement("div");return n.style.whiteSpace="pre",n.textContent=l,n.style.display="inline-block",n.style.width="100%",n.style.whiteSpace="nowrap",n.style.overflow="hidden",n.style.margin="0.5em 0",this.applySectionIndent(n,t),[n]}}}let l=this.makeOutput(t,e);if(l){let e=document.createElement("div");if(this.applyAlignment(e,t),this.applySectionIndent(e,t),this.appendOutput(e,l,t),t.bg_color!==this.DEFAULT_BG){const l=document.createElement("div");return l.style.backgroundColor=this.colorToCss(t.bg_color),l.style.width="100%",l.style.display="block",l.style.padding="0 2px",l.appendChild(e),[l]}return[e]}{const e=document.createElement("br");if(t.bg_color!==this.DEFAULT_BG){const l=document.createElement("div");l.style.backgroundColor=this.colorToCss(t.bg_color),l.style.width="100%",l.style.height="1.2em",l.style.display="block";const n=document.createElement("div");return this.applySectionIndent(n,t),n.appendChild(e),l.appendChild(n),[l]}return[e]}}{const e=document.createElement("br");if(t.bg_color!==this.DEFAULT_BG){const l=document.createElement("div");l.style.backgroundColor=this.colorToCss(t.bg_color),l.style.width="100%",l.style.height="1.2em",l.style.display="block";const n=document.createElement("div");return this.applySectionIndent(n,t),n.appendChild(e),l.appendChild(n),[l]}return[e]}}applyAlignment(e,t){e.style.textAlign=t.align||"left"}applySectionIndent(e,t){let l=2*(t.depth-1);l>0&&(e.style.marginLeft=.6*l+"em")}stateToStyle(e){return{fg:e.fg_color,bg:e.bg_color,bold:e.formatting.bold,underline:e.formatting.underline,italic:e.formatting.italic}}styleToState(e,t){void 0!==e.fg&&null!==e.fg&&(t.fg_color=e.fg),void 0!==e.bg&&null!==e.bg&&(t.bg_color=e.bg),void 0!==e.bold&&null!==e.bold&&(t.formatting.bold=e.bold),void 0!==e.underline&&null!==e.underline&&(t.formatting.underline=e.underline),void 0!==e.italic&&null!==e.italic&&(t.formatting.italic=e.italic)}appendOutput(e,t,l){let n=null,i=null;const r=()=>{n&&(i&&i.bg!==this.DEFAULT_BG&&(n.style.display="inline-block",n.style.padding="0 2px"),e.appendChild(n),n=null,i=null)};for(let l of t)if("string"==typeof l){let t=document.createElement("span");t.innerHTML=l,e.appendChild(t)}else if(Array.isArray(l)&&2===l.length){let[e,t]=l;this.stylesEqual(e,i)||(r(),n=document.createElement("span"),this.applyStyleToElement(n,e),i=e),n.innerHTML+=t}else if(l&&"object"==typeof l)if(r(),"field"===l.type){let t=document.createElement("input");t.type=l.masked?"password":"text",t.name=l.name,t.setAttribute("value",l.data),l.width&&(t.size=l.width),this.applyStyleToElement(t,this.styleFromState(l.style)),e.appendChild(t)}else if("checkbox"===l.type){let t=document.createElement("label"),n=document.createElement("input");n.type="checkbox",n.name=l.name,n.value=l.value,l.prechecked&&n.setAttribute("checked",!0),t.appendChild(n),t.appendChild(document.createTextNode(" "+l.label)),this.applyStyleToElement(t,this.styleFromState(l.style)),e.appendChild(t)}else if("radio"===l.type){let t=document.createElement("label"),n=document.createElement("input");n.type="radio",n.name=l.name,n.value=l.value,l.prechecked&&n.setAttribute("checked",!0),t.appendChild(n),t.appendChild(document.createTextNode(" "+l.label)),this.applyStyleToElement(t,this.styleFromState(l.style)),e.appendChild(t)}else if("link"===l.type){let t=l.url.replace("nomadnetwork://","").replace("lxmf://","");const n=l.url;let i=document.createElement("a");i.href=n,i.title=n;let r=[],s={},a=!1;if(l.fields&&l.fields.length>0){for(const e of l.fields)if("*"===e)a=!0;else if(e.includes("=")){const[t,l]=e.split("=");s[t]=l}else r.push(e);let e="";e=a?"*":r.join("|");const n=Object.entries(s);if(n.length>0){const e=n.map((([e,t])=>`${e}=${t}`)).join("|");t+=t.includes("`")?`|${e}`:`\`${e}`}i.setAttribute("data-destination",`${t}`),i.setAttribute("data-fields",`${e}`)}else i.setAttribute("data-destination",`${t}`);i.classList.add("Mu-nl"),i.setAttribute("data-action","openNode"),i.innerHTML=l.label,this.applyStyleToElement(i,this.styleFromState(l.style)),e.appendChild(i)}r()}stylesEqual(e,t){return!e&&!t||!(!e||!t)&&(e.fg===t.fg&&e.bg===t.bg&&e.bold===t.bold&&e.underline===t.underline&&e.italic===t.italic)}styleFromState(e){return e}applyStyleToElement(e,t){if(!t)return;let l=this.colorToCss(t.fg),n=this.colorToCss(t.bg);l&&"default"!==l&&(e.style.color=l),n&&"default"!==n&&(e.style.backgroundColor=n,e.style.padding="0 2px",e.style.display="inline-block"),t.bold&&(e.style.fontWeight="bold"),t.underline&&(e.style.textDecoration=e.style.textDecoration?e.style.textDecoration+" underline":"underline"),t.italic&&(e.style.fontStyle="italic")}colorToCss(e){if(!e||"default"===e)return null;if(3===e.length&&/^[0-9a-fA-F]{3}$/.test(e))return"#"+e;if(6===e.length&&/^[0-9a-fA-F]{6}$/.test(e))return"#"+e;if(3===e.length&&"g"===e[0]){let t=parseInt(e.slice(1),10);isNaN(t)&&(t=50);let l=Math.floor(2.55*t).toString(16).padStart(2,"0");return"#"+l+l+l}return null}makeOutput(e,t){if(e.literal)return"\\`="===t&&(t="`="),[[this.stateToStyle(e),t]];let l=[],n="",i="text",r=!1,s=0;const a=()=>{n.length>0&&(this.enableForceMonospace?l.push([this.stateToStyle(e),this.splitAtSpaces(n)]):l.push([this.stateToStyle(e),n]),n="")};let o=0;for(;o<t.length;){let c=t[o];if(s>0)s--,o++;else if("formatting"!==i){if(r)n+=c,r=!1;else if("\\"===c)r=!0;else{if("`"===c){if(o+1<t.length&&"`"===t[o+1]){a(),e.formatting.bold=!1,e.formatting.underline=!1,e.formatting.italic=!1,e.fg_color=this.SELECTED_STYLES.plain.fg,e.bg_color=this.DEFAULT_BG,e.align=e.default_align,o+=2;continue}a(),i="formatting",o++;continue}if("["===c){a();let i=this.parseLink(t,o,e);if(i){l.push(i.obj),o+=i.skip;continue}n+="["}else n+=c}o++}else{switch(c){case"_":e.formatting.underline=!e.formatting.underline;break;case"!":e.formatting.bold=!e.formatting.bold;break;case"*":e.formatting.italic=!e.formatting.italic;break;case"F":if(t.length>=o+4){let l=t.substr(o+1,3);e.fg_color=l,s=3}break;case"f":e.fg_color=this.SELECTED_STYLES.plain.fg;break;case"B":if(t.length>=o+4){let l=t.substr(o+1,3);e.bg_color=l,s=3,a()}break;case"b":e.bg_color=this.DEFAULT_BG,a();break;case"`":e.formatting.bold=!1,e.formatting.underline=!1,e.formatting.italic=!1,e.fg_color=this.SELECTED_STYLES.plain.fg,e.bg_color=this.DEFAULT_BG,e.align=e.default_align,i="text";break;case"c":e.align="center";break;case"l":e.align="left";break;case"r":e.align="right";break;case"a":e.align=e.default_align;break;case"<":a();let n=this.parseField(t,o,e);if(n){l.push(n.obj),o+=n.skip;continue}break;case"[":a();let r=this.parseLink(t,o,e);if(r){l.push(r.obj),o+=r.skip;continue}}i="text",o++}}return n.length>0&&(this.enableForceMonospace?l.push([this.stateToStyle(e),this.splitAtSpaces(n)]):l.push([this.stateToStyle(e),n])),l}parseField(e,t,l){let n=t+1,i=e.indexOf("`",n);if(-1===i)return null;let r=e.substring(n,i),s=!1,a=24,o="field",c=r,d="",p=!1;if(r.includes("|")){let e=r.split("|"),t=e[0];if(c=e[1],t.includes("^")?(o="radio",t=t.replace("^","")):t.includes("?")?(o="checkbox",t=t.replace("?","")):t.includes("!")&&(s=!0,t=t.replace("!","")),t.length>0){let e=parseInt(t,10);isNaN(e)||(a=Math.min(e,256))}e.length>2&&(d=e[2]),e.length>3&&"*"===e[3]&&(p=!0)}let u=e.indexOf(">",i);if(-1===u)return null;let h=e.substring(i+1,u),f=this.stateToStyle(l),g=null;return g="checkbox"===o||"radio"===o?{type:o,name:c,value:d||h,label:h,prechecked:p,style:f}:{type:"field",name:c,width:a,masked:s,data:h,style:f},{obj:g,skip:u-t}}parseLink(e,t,l){let n=e.indexOf("]",t);if(-1===n)return null;let i=e.substring(t+1,n),r=i.split("`"),s="",a="",o="";if(1===r.length?(s="",a=i):2===r.length?(s=r[0],a=r[1]):3===r.length&&(s=r[0],a=r[1],o=r[2]),0===a.length)return null;""===s&&(s=a),a=MicronParser.formatNomadnetworkUrl(a),this.enableForceMonospace&&(s=this.splitAtSpaces(s));let c=this.stateToStyle(l);return{obj:{type:"link",url:a,label:s,fields:o?o.split("|"):[],style:c},skip:n-t}}splitAtSpaces(e){let t="",l=e.split(" ");for(let e=0;e<l.length;e++)t+="<span class='Mu-mws'>"+this.forceMonospace(l[e])+"</span>",e<l.length-1&&(t+=" ");return t}forceMonospace(e){let t="",l=e.split("");for(let e of l)t+="<span class='Mu-mnt'>"+e+"</span>";return t}}export default MicronParser;