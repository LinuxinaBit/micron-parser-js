class MicronParser{constructor(e=!0){this.darkTheme=e,this.DEFAULT_FG_DARK="ddd",this.DEFAULT_FG_LIGHT="222",this.DEFAULT_BG="default",this.SELECTED_STYLES=null,this.STYLES_DARK={plain:{fg:this.DEFAULT_FG_DARK,bg:this.DEFAULT_BG,bold:!1,underline:!1,italic:!1},heading1:{fg:"222",bg:"bbb",bold:!1,underline:!1,italic:!1},heading2:{fg:"111",bg:"999",bold:!1,underline:!1,italic:!1},heading3:{fg:"000",bg:"777",bold:!1,underline:!1,italic:!1}},this.STYLES_LIGHT={plain:{fg:this.DEFAULT_FG_LIGHT,bg:this.DEFAULT_BG,bold:!1,underline:!1,italic:!1},heading1:{fg:"000",bg:"777",bold:!1,underline:!1,italic:!1},heading2:{fg:"111",bg:"aaa",bold:!1,underline:!1,italic:!1},heading3:{fg:"222",bg:"ccc",bold:!1,underline:!1,italic:!1}},this.darkTheme?this.SELECTED_STYLES=this.STYLES_DARK:this.SELECTED_STYLES=this.STYLES_LIGHT}static formatNomadnetworkUrl(e){return`nomadnetwork://${e}`}convertMicronToHtml(e){let t="",l={literal:!1,depth:0,fg_color:this.SELECTED_STYLES.plain.fg,bg_color:this.DEFAULT_BG,formatting:{bold:!1,underline:!1,italic:!1,strikethrough:!1},default_align:"left",align:"left",radio_groups:{}},i=e.split("\n");for(let n of i){let a=this.parseLine(n,l);if(a&&a.length>0)for(let r of a)t+=r.outerHTML;else a&&0===a.length||(t+="<br>")}return t}convertMicronToFragment(e){let t=document.createDocumentFragment(),l={literal:!1,depth:0,fg_color:this.SELECTED_STYLES.plain.fg,bg_color:this.DEFAULT_BG,formatting:{bold:!1,underline:!1,italic:!1,strikethrough:!1},default_align:"left",align:"left",radio_groups:{}},i=e.split("\n");for(let n of i){let a=this.parseLine(n,l);if(a&&a.length>0)for(let r of a)t.appendChild(r);else a&&0===a.length||t.appendChild(document.createElement("br"))}return t}parseLine(e,t){if(!(e.length>0))return[document.createElement("br")];{if("`="===e)return t.literal=!t.literal,null;if(!t.literal){if("#"===e[0])return[];if("<"===e[0])return t.depth=0,this.parseLine(e.slice(1),t);if(">"===e[0]){let l=0;for(;l<e.length&&">"===e[l];)l++;t.depth=l;let i=e.slice(l);if(!(i.length>0))return null;{let n=null,a="heading"+l;n=this.SELECTED_STYLES[a]?this.SELECTED_STYLES[a]:this.SELECTED_STYLES.plain;let r=this.stateToStyle(t);this.styleToState(n,t);let s=this.makeOutput(t,i);if(this.styleToState(r,t),s&&s.length>0){let o=document.createElement("div");o.style.display="inline-block",o.style.width="100%",this.applyStyleToElement(o,n);let d=document.createElement("div");return this.applySectionIndent(d,t),this.appendOutput(d,s,t),o.appendChild(d),[o]}if(!s||!(s.length>0))return null;{let p=document.createElement("div");return this.applyAlignment(p,t),this.applySectionIndent(p,t),this.appendOutput(p,s,t),[p]}}}if("-"===e[0]){if(1===e.length){let c=document.createElement("hr");return this.applySectionIndent(c,t),[c]}{let f=e[1],h=f.repeat(250),u=document.createElement("div");return u.style.whiteSpace="pre",u.textContent=h,u.style.display="inline-block",u.style.width="100%",u.style.whiteSpace="nowrap",u.style.overflow="hidden",u.style.margin="0.5em 0",this.applySectionIndent(u,t),[u]}}}let g=this.makeOutput(t,e);if(!g)return[document.createElement("br")];{let b=document.createElement("div");return this.applyAlignment(b,t),this.applySectionIndent(b,t),this.appendOutput(b,g,t),[b]}}}applyAlignment(e,t){e.style.textAlign=t.align||"left"}applySectionIndent(e,t){let l=(t.depth-1)*2;l>0&&(e.style.marginLeft=.6*l+"em")}stateToStyle(e){return{fg:e.fg_color,bg:e.bg_color,bold:e.formatting.bold,underline:e.formatting.underline,italic:e.formatting.italic}}styleToState(e,t){void 0!==e.fg&&null!==e.fg&&(t.fg_color=e.fg),void 0!==e.bg&&null!==e.bg&&(t.bg_color=e.bg),void 0!==e.bold&&null!==e.bold&&(t.formatting.bold=e.bold),void 0!==e.underline&&null!==e.underline&&(t.formatting.underline=e.underline),void 0!==e.italic&&null!==e.italic&&(t.formatting.italic=e.italic)}appendOutput(e,t,l){let i=null,n=null,a=()=>{i&&(e.appendChild(i),i=null,n=null)};for(let r of t)if("string"==typeof r){let s=document.createElement("span");s.innerHTML=r,e.appendChild(s)}else if(Array.isArray(r)&&2===r.length){let[o,d]=r;this.stylesEqual(o,n)||(a(),i=document.createElement("span"),this.applyStyleToElement(i,o),n=o),i.innerHTML+=d}else if(r&&"object"==typeof r){if(a(),"field"===r.type){let p=document.createElement("input");p.type=r.masked?"password":"text",p.name=r.name,p.setAttribute("value",r.data),r.width&&(p.size=r.width),this.applyStyleToElement(p,this.styleFromState(r.style)),e.appendChild(p)}else if("checkbox"===r.type){let c=document.createElement("label"),f=document.createElement("input");f.type="checkbox",f.name=r.name,f.value=r.value,r.prechecked&&f.setAttribute("checked",!0),c.appendChild(f),c.appendChild(document.createTextNode(" "+r.label)),this.applyStyleToElement(c,this.styleFromState(r.style)),e.appendChild(c)}else if("radio"===r.type){let h=document.createElement("label"),u=document.createElement("input");u.type="radio",u.name=r.name,u.value=r.value,r.prechecked&&u.setAttribute("checked",!0),h.appendChild(u),h.appendChild(document.createTextNode(" "+r.label)),this.applyStyleToElement(h,this.styleFromState(r.style)),e.appendChild(h)}else if("link"===r.type){let g=r.url.replace("nomadnetwork://","").replace("lxmf://",""),b=r.url,m=document.createElement("a");m.href=b,m.title=b;let E=[],y={},S=!1;if(r.fields&&r.fields.length>0){for(let _ of r.fields)if("*"===_)S=!0;else if(_.includes("=")){let[T,$]=_.split("=");y[T]=$}else E.push(_);let L="";L=S?"*":E.join("|");let k=Object.entries(y);if(k.length>0){let D=k.map(([e,t])=>`${e}=${t}`).join("|");g+=g.includes("`")?`|${D}`:`\`${D}`}m.setAttribute("onclick",`event.preventDefault(); onNodePageUrlClick('${g}', '${L}', false, false)`)}else m.setAttribute("onclick",`event.preventDefault(); onNodePageUrlClick('${g}', null, false, false)`);m.innerHTML=r.label,this.applyStyleToElement(m,this.styleFromState(r.style)),e.appendChild(m)}}a()}stylesEqual(e,t){return!e&&!t||!!e&&!!t&&e.fg===t.fg&&e.bg===t.bg&&e.bold===t.bold&&e.underline===t.underline&&e.italic===t.italic}styleFromState(e){return e}applyStyleToElement(e,t){if(!t)return;let l=this.colorToCss(t.fg),i=this.colorToCss(t.bg);l&&"default"!==l&&(e.style.color=l),i&&"default"!==i&&(e.style.backgroundColor=i),t.bold&&(e.style.fontWeight="bold"),t.underline&&(e.style.textDecoration=e.style.textDecoration?e.style.textDecoration+" underline":"underline"),t.italic&&(e.style.fontStyle="italic")}colorToCss(e){if(!e||"default"===e)return null;if(3===e.length&&/^[0-9a-fA-F]{3}$/.test(e)||6===e.length&&/^[0-9a-fA-F]{6}$/.test(e))return"#"+e;if(3===e.length&&"g"===e[0]){let t=parseInt(e.slice(1),10);isNaN(t)&&(t=50);let l=Math.floor(2.55*t).toString(16).padStart(2,"0");return"#"+l+l+l}return null}makeOutput(e,t){if(e.literal)return"\\`="===t&&(t="`="),[[this.stateToStyle(e),t]];let l=[],i="",n="text",a=!1,r=0,s=()=>{i.length>0&&(l.push([this.stateToStyle(e),this.splitAtSpaces(i)]),i="")},o=0;for(;o<t.length;){let d=t[o];if(r>0){r--,o++;continue}if("formatting"===n){switch(d){case"_":e.formatting.underline=!e.formatting.underline;break;case"!":e.formatting.bold=!e.formatting.bold;break;case"*":e.formatting.italic=!e.formatting.italic;break;case"F":if(t.length>=o+4){let p=t.substr(o+1,3);e.fg_color=p,r=3}break;case"f":e.fg_color=this.SELECTED_STYLES.plain.fg;break;case"B":if(t.length>=o+4){let c=t.substr(o+1,3);e.bg_color=c,r=3}break;case"b":e.bg_color=this.DEFAULT_BG;break;case"`":e.formatting.bold=!1,e.formatting.underline=!1,e.formatting.italic=!1,e.fg_color=this.SELECTED_STYLES.plain.fg,e.bg_color=this.DEFAULT_BG,e.align=e.default_align,n="text";break;case"c":e.align="center";break;case"l":e.align="left";break;case"r":e.align="right";break;case"a":e.align=e.default_align;break;case"<":s();let f=this.parseField(t,o,e);if(f){l.push(f.obj),o+=f.skip;continue}break;case"[":s();let h=this.parseLink(t,o,e);if(h){l.push(h.obj),o+=h.skip;continue}}n="text",o++;continue}if(a)i+=d,a=!1;else if("\\"===d)a=!0;else if("`"===d){if(o+1<t.length&&"`"===t[o+1]){s(),e.formatting.bold=!1,e.formatting.underline=!1,e.formatting.italic=!1,e.fg_color=this.SELECTED_STYLES.plain.fg,e.bg_color=this.DEFAULT_BG,e.align=e.default_align,o+=2;continue}s(),n="formatting",o++;continue}else if("["===d){s();let u=this.parseLink(t,o,e);if(u){l.push(u.obj),o+=u.skip;continue}i+="["}else i+=d;o++}return i.length>0&&l.push([this.stateToStyle(e),this.splitAtSpaces(i)]),l.length>0?l:null}parseField(e,t,l){let i=t+1,n=e.indexOf("`",i);if(-1===n)return null;let a=e.substring(i,n),r=!1,s=24,o="field",d=a,p="",c=!1;if(a.includes("|")){let f=a.split("|"),h=f[0];if(d=f[1],h.includes("^")?(o="radio",h=h.replace("^","")):h.includes("?")?(o="checkbox",h=h.replace("?","")):h.includes("!")&&(r=!0,h=h.replace("!","")),h.length>0){let u=parseInt(h,10);isNaN(u)||(s=Math.min(u,256))}f.length>2&&(p=f[2]),f.length>3&&"*"===f[3]&&(c=!0)}let g=e.indexOf(">",n);if(-1===g)return null;let b=e.substring(n+1,g),m=this.stateToStyle(l),E=null;return{obj:E="checkbox"===o||"radio"===o?{type:o,name:d,value:p||b,label:b,prechecked:c,style:m}:{type:"field",name:d,width:s,masked:r,data:b,style:m},skip:g-t}}parseLink(e,t,l){let i=e.indexOf("]",t);if(-1===i)return null;let n=e.substring(t+1,i),a=n.split("`"),r="",s="",o="";if(1===a.length?(r="",s=n):2===a.length?(r=a[0],s=a[1]):3===a.length&&(r=a[0],s=a[1],o=a[2]),0===s.length)return null;""===r&&(r=s),s=MicronParser.formatNomadnetworkUrl(s),r=this.splitAtSpaces(r);let d=this.stateToStyle(l),p;return{obj:{type:"link",url:s,label:r,fields:o?o.split("|"):[],style:d},skip:i-t}}splitAtSpaces(e){let t="",l=e.split(" ");for(let i=0;i<l.length;i++)t+="<span class='wordSpan'>"+this.forceMonospace(l[i])+"</span>",i<l.length-1&&(t+=" ");return t}forceMonospace(e){let t="",l=e.split("");for(let i of l)t+="<span class='nodeText'>"+i+"</span>";return t}}export default MicronParser;